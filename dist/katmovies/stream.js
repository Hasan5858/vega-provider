"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(o,m,k,k2){void 0===k2&&(k2=k);var desc=Object.getOwnPropertyDescriptor(m,k);desc&&!("get"in desc?!m.__esModule:desc.writable||desc.configurable)||(desc={enumerable:!0,get:function(){return m[k]}}),Object.defineProperty(o,k2,desc)}:function(o,m,k,k2){void 0===k2&&(k2=k),o[k2]=m[k]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(o,v){Object.defineProperty(o,"default",{enumerable:!0,value:v})}:function(o,v){o.default=v}),__importStar=this&&this.__importStar||function(){var ownKeys=function(o){return ownKeys=Object.getOwnPropertyNames||function(o){var ar=[];for(var k in o)Object.prototype.hasOwnProperty.call(o,k)&&(ar[ar.length]=k);return ar},ownKeys(o)};return function(mod){if(mod&&mod.__esModule)return mod;var result={};if(null!=mod)for(var k=ownKeys(mod),i=0;i<k.length;i++)"default"!==k[i]&&__createBinding(result,mod,k[i]);return __setModuleDefault(result,mod),result}}(),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P(function(resolve){resolve(value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getStream=void 0;const cheerio=__importStar(require("cheerio"));function getServerName(url){return url.includes("hubcloud.ink")?"HubCloud":url.includes("gd.kmhd.net")?"GDFlix":url.includes("katdrive.eu")?"KatDrive":url.includes("clicknupload.click")?"ClicknUpload":url.includes("fuckingfast.net")?"FuckingFast":url.includes("1fichier.com")?"1fichier":url.includes("1xplayer.com")?"1xPlayer":"Unknown"}function extractDirectFileUrl(url,providerContext){return __awaiter(this,void 0,void 0,function*(){const{axios:axios,cheerio:cheerio}=providerContext;try{const response=yield axios.get(url,{headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"},timeout:1e4}),downloadLinks=cheerio.load(response.data)('a[href*="download"], a[href*=".mp4"], a[href*=".mkv"], a[href*=".avi"], a[href*=".mov"], a[href*=".wmv"], a[href*=".flv"], a[href*=".webm"]');if(downloadLinks.length>0){const directLink=downloadLinks.first().attr("href");if(directLink){return directLink.startsWith("http")?directLink:`${url.split("/").slice(0,3).join("/")}${directLink}`}}const scriptContent=response.data,urlPatterns=[/downloadUrl['":\s]*['"]([^'"]+)['"]/gi,/fileUrl['":\s]*['"]([^'"]+)['"]/gi,/directUrl['":\s]*['"]([^'"]+)['"]/gi,/url['":\s]*['"]([^'"]+\.(mp4|mkv|avi|mov|wmv|flv|webm))['"]/gi];for(const pattern of urlPatterns){const matches=scriptContent.match(pattern);if(matches&&matches.length>0){const directUrl=matches[1];if(directUrl){return directUrl.startsWith("http")?directUrl:`${url.split("/").slice(0,3).join("/")}${directUrl}`}}}return url.includes(".mp4")||url.includes(".mkv")||url.includes(".avi")||url.includes(".mov")||url.includes(".wmv")||url.includes(".flv")||url.includes(".webm")?url:null}catch(error){return null}})}function scrape1xplayerDirectUrl(url,providerContext){return __awaiter(this,void 0,void 0,function*(){const{axios:axios,cheerio:cheerio}=providerContext;try{const response=yield axios.get(url,{timeout:1e4,headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"}}),$=cheerio.load(response.data);let directUrl=null;const videoSrc=$("video source").attr("src");if(videoSrc)return directUrl=videoSrc.startsWith("http")?videoSrc:`${url.split("/").slice(0,3).join("/")}${videoSrc}`,directUrl;const iframeElements=$("iframe");for(let i=0;i<iframeElements.length;i++){const iframeSrc=$(iframeElements[i]).attr("src");if(iframeSrc&&(iframeSrc.includes("player")||iframeSrc.includes("embed")))try{const iframeResponse=yield axios.get(iframeSrc,{timeout:1e4,headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"}}),iframeVideoSrc=cheerio.load(iframeResponse.data)("video source").attr("src");if(iframeVideoSrc)return directUrl=iframeVideoSrc.startsWith("http")?iframeVideoSrc:`${iframeSrc.split("/").slice(0,3).join("/")}${iframeVideoSrc}`,directUrl}catch(iframeError){}}const scriptContent=response.data,urlPatterns=[/file:\s*["']([^"']+\.(mp4|mkv|avi|mov|wmv|flv|webm))["']/i,/src:\s*["']([^"']+\.(mp4|mkv|avi|mov|wmv|flv|webm))["']/i,/url:\s*["']([^"']+\.(mp4|mkv|avi|mov|wmv|flv|webm))["']/i,/"url":\s*"([^"]+\.(mp4|mkv|avi|mov|wmv|flv|webm))"/i,/'url':\s*'([^']+\.(mp4|mkv|avi|mov|wmv|flv|webm))'/i,/videoUrl:\s*["']([^"']+)["']/i,/streamUrl:\s*["']([^"']+)["']/i,/playUrl:\s*["']([^"']+)["']/i,/downloadUrl:\s*["']([^"']+)["']/i,/fileUrl:\s*["']([^"']+)["']/i];for(let i=0;i<urlPatterns.length;i++){const pattern=urlPatterns[i],match=scriptContent.match(pattern);if(match&&match[1])return directUrl=match[1].startsWith("http")?match[1]:`${url.split("/").slice(0,3).join("/")}${match[1]}`,directUrl}const dataUrl=$("[data-url]").attr("data-url")||$("[data-src]").attr("data-src")||$("[data-file]").attr("data-file");if(dataUrl)return directUrl=dataUrl.startsWith("http")?dataUrl:`${url.split("/").slice(0,3).join("/")}${dataUrl}`,directUrl;const videoLinks=$('a[href*=".mp4"], a[href*=".mkv"], a[href*=".avi"], a[href*=".mov"], a[href*=".wmv"], a[href*=".flv"], a[href*=".webm"]');if(videoLinks.length>0){const videoLink=videoLinks.first().attr("href");if(videoLink)return directUrl=videoLink.startsWith("http")?videoLink:`${url.split("/").slice(0,3).join("/")}${videoLink}`,directUrl}const allLinks=$("a[href]");for(let i=0;i<Math.min(allLinks.length,10);i++){const href=$(allLinks[i]).attr("href");if(href&&(href.includes(".mp4")||href.includes(".mkv")||href.includes(".avi")||href.includes(".mov")||href.includes(".wmv")||href.includes(".flv")||href.includes(".webm")))return directUrl=href.startsWith("http")?href:`${url.split("/").slice(0,3).join("/")}${href}`,directUrl}return null}catch(error){return null}})}function extractKmhdLink(katlink,providerContext){return __awaiter(this,void 0,void 0,function*(){var _a;const{axios:axios}=providerContext,debugLog=(message,data)=>{"undefined"!=typeof window&&window.console&&window.console.log(`[KATMOVIE EXTRACT] ${message}`,data||"")};debugLog("Starting extractKmhdLink",{katlink:katlink});try{const initialResponse=yield axios.get(katlink,{headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",Referer:"https://katmoviehd.observer/"}});if(null===(_a=initialResponse.request.res.responseUrl)||void 0===_a?void 0:_a.includes("/locked")){const $locked=cheerio.load(initialResponse.data),action=$locked("form").attr("action");if(!action)return null;const unlockUrl=`https://links.kmhd.net/locked${action}`,unlockResponse=yield axios.post(unlockUrl,{},{headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",Referer:initialResponse.request.res.responseUrl,"Content-Type":"application/x-www-form-urlencoded",Origin:"https://links.kmhd.net"},maxRedirects:5}),unlockedData=(yield axios.get(katlink,{headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",Referer:unlockResponse.request.res.responseUrl||katlink,Cookie:unlockResponse.headers["set-cookie"]?unlockResponse.headers["set-cookie"].join("; "):""}})).data,uploadLinksMatch=unlockedData.match(/upload_links:\{([^}]+)\}/);if(uploadLinksMatch){const uploadLinksStr=uploadLinksMatch[1],uploadLinks={};uploadLinksStr.split(",").forEach(pair=>{const[key,value]=pair.split(":");key&&value&&(uploadLinks[key.trim()]=value.trim().replace(/"/g,""))});const serverLinks={},hubdriveMatch=unlockedData.match(/hubdrive_res:\{mx:(\d+),link:"([^"]+)"/);hubdriveMatch&&(serverLinks.hubdrive_res={mx:parseInt(hubdriveMatch[1]),link:hubdriveMatch[2]});const gdflixMatch=unlockedData.match(/gdflix_res:\{mx:(\d+),link:"([^"]+)"/);gdflixMatch&&(serverLinks.gdflix_res={mx:parseInt(gdflixMatch[1]),link:gdflixMatch[2]});const katdriveMatch=unlockedData.match(/katdrive_res:\{mx:(\d+),link:"([^"]+)"/);katdriveMatch&&(serverLinks.katdrive_res={mx:parseInt(katdriveMatch[1]),link:katdriveMatch[2]});const clicknuploadMatch=unlockedData.match(/clicknupload_res:\{mx:(\d+),link:"([^"]+)"/);clicknuploadMatch&&(serverLinks.clicknupload_res={mx:parseInt(clicknuploadMatch[1]),link:clicknuploadMatch[2]});const ffastMatch=unlockedData.match(/ffast_res:\{mx:(\d+),link:"([^"]+)"/);ffastMatch&&(serverLinks.ffast_res={mx:parseInt(ffastMatch[1]),link:ffastMatch[2]});const fichierMatch=unlockedData.match(/fichier_res:\{mx:(\d+),link:"([^"]+)"/);fichierMatch&&(serverLinks.fichier_res={mx:parseInt(fichierMatch[1]),link:fichierMatch[2]});const serverOrder=["hubdrive_res","gdflix_res","katdrive_res","clicknupload_res","ffast_res","fichier_res"];debugLog("Trying server URLs",{serverOrder:serverOrder,uploadLinks:uploadLinks,serverLinks:serverLinks});for(const serverKey of serverOrder)if(debugLog(`Checking ${serverKey}`,{hasUploadLink:!!uploadLinks[serverKey],uploadLink:uploadLinks[serverKey],hasServerLink:!!serverLinks[serverKey],serverLink:serverLinks[serverKey]}),uploadLinks[serverKey]&&"None"!==uploadLinks[serverKey]&&serverLinks[serverKey]){const serverUrl=serverLinks[serverKey].link+uploadLinks[serverKey];return debugLog(`Found ${serverKey} link`,{serverUrl:serverUrl}),serverUrl}}const chibiPathMatch=unlockedData.match(/"PUBLIC_CHIBI_PATH":"([^"]+)"/);if(chibiPathMatch&&chibiPathMatch[1]){const baseUrl=chibiPathMatch[1],fileIdMatch=katlink.match(/\/file\/([^\/]+)$/);if(fileIdMatch&&fileIdMatch[1]){return`${baseUrl}/${fileIdMatch[1]}`}}}else{const chibiPathMatch=initialResponse.data.match(/"PUBLIC_CHIBI_PATH":"([^"]+)"/);if(chibiPathMatch&&chibiPathMatch[1]){const baseUrl=chibiPathMatch[1],fileIdMatch=katlink.match(/\/file\/([^\/]+)$/);if(fileIdMatch&&fileIdMatch[1]){return`${baseUrl}/${fileIdMatch[1]}`}}}return null}catch(error){return null}})}const getStream=function(_a){return __awaiter(this,arguments,void 0,function*({link:link,signal:signal,providerContext:providerContext}){const{axios:axios,cheerio:cheerio,extractors:extractors}=providerContext,{hubcloudExtracter:hubcloudExtracter,gdFlixExtracter:gdFlixExtracter}=extractors,debugLog=(message,data)=>{"undefined"!=typeof window&&window.console&&window.console.log(`[KATMOVIE DEBUG] ${message}`,data||"")};debugLog("Starting stream extraction",{link:link});try{if(link.includes("gdflix"))return yield gdFlixExtracter(link,signal);if(link.includes("kmhd")){debugLog("Processing kmhd link, calling extractKmhdLink");const hubcloudLink=yield extractKmhdLink(link,providerContext);if(debugLog("extractKmhdLink result",{hubcloudLink:hubcloudLink}),!hubcloudLink)return debugLog("extractKmhdLink returned null/undefined"),[];if(hubcloudLink.includes("hubcloud.ink")){debugLog("HubCloud URL detected, using hubcloudExtractor",{hubcloudLink:hubcloudLink});const result=yield hubcloudExtracter(hubcloudLink,signal);return debugLog("hubcloudExtracter result",{count:result.length,streams:result}),result}if(hubcloudLink.includes("1xplayer.com"))try{const directUrl=yield scrape1xplayerDirectUrl(hubcloudLink,providerContext);if(directUrl)return[{server:"1xPlayer",link:directUrl,type:"mkv",quality:"1080"}];try{const hubcloudStreams=yield hubcloudExtracter(hubcloudLink,signal);if(hubcloudStreams.length>0)return hubcloudStreams}catch(hubcloudError){}return[{server:"1xPlayer",link:hubcloudLink,type:"mkv",quality:"1080"}]}catch(error){return[{server:"1xPlayer",link:hubcloudLink,type:"mkv",quality:"1080"}]}else if(hubcloudLink.includes("gd.kmhd.net")||hubcloudLink.includes("katdrive.eu")||hubcloudLink.includes("clicknupload.click")||hubcloudLink.includes("fuckingfast.net")||hubcloudLink.includes("1fichier.com"))try{const directUrl=yield extractDirectFileUrl(hubcloudLink,providerContext);return directUrl?[{server:getServerName(hubcloudLink),link:directUrl,type:"mkv",quality:"1080"}]:[{server:getServerName(hubcloudLink),link:hubcloudLink,type:"mkv",quality:"1080"}]}catch(error){return[{server:getServerName(hubcloudLink),link:hubcloudLink,type:"mkv",quality:"1080"}]}return yield hubcloudExtracter(hubcloudLink,signal)}return yield hubcloudExtracter(link,signal)}catch(error){return[]}})};exports.getStream=getStream;