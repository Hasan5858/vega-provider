"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P(function(resolve){resolve(value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getStream=void 0;const blowfish_1=require("./blowfish"),USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.0.0 Safari/537.36",QUALITY_MAP={quality_cam:"360",quality_ts:"480",quality_dvd:"720",quality_hd:"1080"},randomAlphaNumeric=length=>{const chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let result="";for(let i=0;i<length;i++)result+=chars.charAt(Math.floor(62*Math.random()));return result},mapQuality=className=>{if(className)for(const token of className.split(" "))if(QUALITY_MAP[token])return QUALITY_MAP[token]};function handlePrimeSrcEmbed(url,axios,cheerioModule){return __awaiter(this,void 0,void 0,function*(){try{const embedRes=yield axios.get(url),$=cheerioModule.load(embedRes.data),streams=[];return $('video source, source[src*=".mp4"], source[src*=".m3u8"]').each((index,el)=>{const src=$(el).attr("src");if(!src)return;const absolute=src.startsWith("http")?src:`https://primesrc.me${src}`;streams.push({server:`PrimeSrc ${index+1}`,link:absolute,type:absolute.includes(".m3u8")?"m3u8":"mp4"})}),0===streams.length&&$("[data-src]").each((index,el)=>{const src=$(el).attr("data-src");if(src&&(src.includes(".mp4")||src.includes(".m3u8"))){const absolute=src.startsWith("http")?src:`https://primesrc.me${src}`;streams.push({server:`PrimeSrc ${index+1}`,link:absolute,type:absolute.includes(".m3u8")?"m3u8":"mp4"})}}),0===streams.length&&streams.push({server:"PrimeSrc Embed",link:url,type:"iframe"}),streams}catch(error){return[]}})}const extractMixdrop=(mixdropUrl,axios)=>__awaiter(void 0,void 0,void 0,function*(){try{const embedUrl=mixdropUrl.replace("/f/","/e/"),{data:data}=yield axios.get(embedUrl,{headers:{"User-Agent":USER_AGENT,Referer:mixdropUrl,Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8","Accept-Language":"en-US,en;q=0.9","Cache-Control":"no-cache",Pragma:"no-cache"}}),match=/eval\(function\((.*?)\)\{.*?return p\}.*?\('(.*?)'\.split/.exec(data);if(!match)return null;const encodedString=match[2],header=encodedString.split(",'|MDCore|")[0].split(","),base=Number(header[header.length-1]);if(Number.isNaN(base))return null;const splitMarker=`',${base},`,[p,remainder]=encodedString.split(splitMarker);if(!p||!remainder)return null;const body=remainder.slice(2).split("|"),wurl=function(payload,a,c,k,e,d){if(e=function(index){return index.toString(36)},!"".replace(/^/,String)){for(;c--;)d[c.toString(a)]=k[c]||c.toString(a);k=[function(value){return d[value]}],e=function(){return"\\w+"},c=1}for(;c--;)if(k[c]){const regex=new RegExp(`\\b${e(c)}\\b`,"g");payload=payload.replace(regex,k[c])}return payload}(p.trim(),base,body.length,body,value=>value.toString(36),{}).match(/MDCore\.wurl="([^"]+)"/);if(!wurl||!wurl[1])return null;return{link:wurl[1].startsWith("http")?wurl[1]:`https:${wurl[1]}`,headers:{"User-Agent":USER_AGENT,Referer:embedUrl}}}catch(error){return null}}),extractDoodStream=(doodUrl,axios)=>__awaiter(void 0,void 0,void 0,function*(){try{const url=new URL(doodUrl),id=url.pathname.split("/").pop();if(!id)return null;const candidateHosts=Array.from(new Set([`${url.protocol}//${url.hostname}`,"https://dsvplay.com","https://dood.la","https://dood.ws","https://dood.cx"]));let embedHtml=null,activeHost=null;for(const host of candidateHosts){const embedUrl=`${host}/e/${id}`;try{const{data:data}=yield axios.get(embedUrl,{headers:{"User-Agent":USER_AGENT,Referer:`${host}/d/${id}`,Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8","Accept-Language":"en-US,en;q=0.9","Cache-Control":"no-cache",Pragma:"no-cache"}});embedHtml=data,activeHost=host;break}catch(_a){continue}}if(!embedHtml||!activeHost)return null;const passMatch=embedHtml.match(/\/pass_md5\/([^'\"]+)/),tokenMatch=embedHtml.match(/token=([a-z0-9]+)/i);if(!passMatch||!tokenMatch)return null;const embedUrl=`${activeHost}/e/${id}`,passUrl=`${activeHost}/pass_md5/${passMatch[1]}`,response=yield axios.get(passUrl,{headers:{"User-Agent":USER_AGENT,Referer:embedUrl,Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8","Accept-Language":"en-US,en;q=0.9","Cache-Control":"no-cache",Pragma:"no-cache"}}),baseStream="string"==typeof response.data?response.data:null;if(!baseStream)return null;const token=tokenMatch[1];return{link:`${baseStream}${randomAlphaNumeric(10)}?token=${token}&expiry=${Date.now()}`,headers:{"User-Agent":USER_AGENT,Referer:embedUrl}}}catch(error){return null}}),extractStreamTape=(streamTapeUrl,axios)=>__awaiter(void 0,void 0,void 0,function*(){var _a;try{const{data:data}=yield axios.get(streamTapeUrl,{headers:{"User-Agent":USER_AGENT,Referer:streamTapeUrl,Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8","Accept-Language":"en-US,en;q=0.9","Cache-Control":"no-cache",Pragma:"no-cache"}}),html=data,directMatch=null!==(_a=html.match(/id="robotlink"[^>]*>([^<]+)</))&&void 0!==_a?_a:html.match(/document\.getElementById\('robotlink'\)\.innerHTML\s*=\s*'([^']+)'/);if(!directMatch||!directMatch[1])return null;const rawLink=directMatch[1].replace(/\\u0026/g,"&").replace(/&amp;/g,"&").trim(),normalized=rawLink.startsWith("http")||rawLink.startsWith("https")?rawLink:rawLink.startsWith("//")?`https:${rawLink}`:rawLink.startsWith("/")?`https://${new URL(streamTapeUrl).hostname}${rawLink}`:rawLink;return{link:normalized.includes("&stream=")||normalized.includes("stream=")?normalized:`${normalized}&stream=1`,headers:{"User-Agent":USER_AGENT,Referer:streamTapeUrl}}}catch(error){return null}}),resolveGoEntries=(url,$,axios)=>__awaiter(void 0,void 0,void 0,function*(){const baseUrl=new URL(url).origin,linkKeys=(0,blowfish_1.decodeLinkKeys)($("#user-data").attr("v")||""),entries=[];if($("a.go-link").each((_,element)=>{const versionAttr=$(element).attr("link_version");if(!versionAttr)return;const index=Number(versionAttr);if(Number.isNaN(index))return;const row=$(element).closest("tr");entries.push({index:index,fallbackKey:$(element).attr("key")||null,host:row.find(".version-host").text().trim(),quality:mapQuality(row.find(".link_version_quality span").attr("class")||void 0)})}),!entries.length)return[];const results=[];for(const entry of entries){const key=linkKeys[entry.index]||entry.fallbackKey;if(!key)continue;const goUrl=`${baseUrl}/links/go/${encodeURIComponent(key)}?embed=true`;let goData;try{goData=(yield axios.get(goUrl,{headers:{"User-Agent":USER_AGENT,Referer:url,Accept:"application/json, text/plain, */*"}})).data}catch(error){continue}const directLink="string"==typeof goData?goData:(null==goData?void 0:goData.link)||(null==goData?void 0:goData.url)||null;if(!directLink)continue;const hostLabel=((null==goData?void 0:goData.host)||entry.host||"Primewire").trim(),host=hostLabel.toLowerCase();let extracted=null;if(directLink.includes("mixdrop")||host.includes("mixdrop")?(extracted=yield extractMixdrop(directLink,axios),extracted&&(extracted.type=extracted.type||"mp4")):directLink.includes("dood")||host.includes("dood")?(extracted=yield extractDoodStream(directLink,axios),extracted&&(extracted.type=extracted.type||"mp4")):(directLink.includes("streamtape")||directLink.includes("streamta")||host.includes("streamtape"))&&(extracted=yield extractStreamTape(directLink,axios),extracted&&(extracted.type=extracted.type||"mp4")),extracted){results.push({server:hostLabel,link:extracted.link,type:extracted.type||"mp4",quality:entry.quality,headers:extracted.headers});continue}const fallbackType=directLink.includes(".m3u8")?"m3u8":directLink.match(/\.(mp4|mkv|webm)(\?|$)/)?"mp4":"iframe";results.push({server:hostLabel,link:directLink,type:fallbackType,quality:entry.quality})}return results}),getStream=function(_a){return __awaiter(this,arguments,void 0,function*({link:url,type:type,providerContext:providerContext}){const{axios:axios,cheerio:cheerio}=providerContext;try{if(url.includes("primesrc.me"))return yield handlePrimeSrcEmbed(url,axios,cheerio);const pageResponse=yield axios.get(url,{headers:{"User-Agent":USER_AGENT,Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8","Accept-Language":"en-US,en;q=0.9"}}),$=cheerio.load(pageResponse.data),decodedStreams=yield resolveGoEntries(url,$,axios);if(decodedStreams.length)return decodedStreams;const mixdropCandidates=[];if($("a.embed-link").each((_,element)=>{const href=$(element).attr("href")||"";href.includes("mixdrop")&&mixdropCandidates.push({server:"Mixdrop",link:href,type:"iframe"})}),mixdropCandidates.length){const streams=[];for(const candidate of mixdropCandidates){const extracted=yield extractMixdrop(candidate.link,axios);extracted&&streams.push({server:candidate.server,link:extracted.link,type:"mp4",headers:extracted.headers})}if(streams.length)return streams}return[]}catch(error){return[]}})};exports.getStream=getStream;