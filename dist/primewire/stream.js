"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P(function(resolve){resolve(value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getStream=void 0;const blowfish_1=require("./blowfish");function handlePrimeSrcEmbed(url,axios,cheerio){return __awaiter(this,void 0,void 0,function*(){try{const urlObj=new URL(url),embedRes=(urlObj.searchParams.get("s_id"),urlObj.pathname.includes("/tv/"),yield axios.get(url)),$=cheerio.load(embedRes.data),streamLinks=[];return $('video source, source[src*=".mp4"], source[src*=".m3u8"]').each((i,el)=>{const src=$(el).attr("src");src&&streamLinks.push({server:`Stream ${i+1}`,link:src.startsWith("http")?src:`https://primesrc.me${src}`,type:src.includes("m3u8")?"m3u8":"mp4"})}),0===streamLinks.length&&$("[data-src]").each((i,el)=>{const dataSrc=$(el).attr("data-src");dataSrc&&(dataSrc.includes(".mp4")||dataSrc.includes(".m3u8"))&&streamLinks.push({server:`Source ${i+1}`,link:dataSrc.startsWith("http")?dataSrc:`https://primesrc.me${dataSrc}`,type:dataSrc.includes("m3u8")?"m3u8":"mp4"})}),0===streamLinks.length&&streamLinks.push({server:"Embed",link:url,type:"iframe"}),streamLinks}catch(err){return[]}})}const getStream=function(_a){return __awaiter(this,arguments,void 0,function*({link:url,type:type,providerContext:providerContext}){var _b,_c,_d,_e,_f,_g;const{axios:axios,cheerio:cheerio}=providerContext;try{if(url.includes("primesrc.me"))return yield handlePrimeSrcEmbed(url,axios,cheerio);const baseUrl=url.split("/").slice(0,3).join("/"),res=yield axios.get(url),$=cheerio.load(res.data),userData=$("#user-data").attr("v");if(userData&&userData.length>10){const decodedKeys=(0,blowfish_1.decodeLinkKeys)(userData),streamLinks=[];if($("[data-wp-menu]").each((i,element)=>{const wpMenuKey=$(element).attr("data-wp-menu");if(!wpMenuKey||!decodedKeys.includes(wpMenuKey))return;const $row=$(element).closest("tr"),domain=($row.find(".embed-link").text().trim(),$row.find(".version-host").text().trim()),qualitySize=$row.find(".quality_tag").text().trim();if(domain&&qualitySize){const streamUrl=`${baseUrl}/links/gos/${wpMenuKey}`;streamLinks.push({server:`${domain} - ${qualitySize}`,link:streamUrl,type:"iframe"})}}),streamLinks.length>0)return streamLinks}const streamLinks=[],urls=[];if($("tr").each((i,element)=>{if($(element).text().toLowerCase().includes("mixdrop")){const id=$(element).find(".wp-menu-btn").attr("data-wp-menu"),size=$(element).find(".wp-menu-btn").next().text();id&&urls.push({id:baseUrl+"/links/go/"+id,size:size})}}),0===urls.length)return[];for(const url of urls)try{const res2=yield axios.head(url.id),location=null===(_b=res2.request)||void 0===_b?void 0:_b.responseURL.replace("/f/","/e/"),res3=yield fetch(location,{credentials:"include",headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:101.0) Gecko/20100101 Firefox/101.0",Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8","Accept-Language":"en-US,en;q=0.5","Upgrade-Insecure-Requests":"1","Sec-Fetch-Dest":"iframe","Sec-Fetch-Mode":"navigate","Sec-Fetch-Site":"same-origin",Pragma:"no-cache","Cache-Control":"no-cache",referer:null===(_c=res2.request)||void 0===_c?void 0:_c.responseURL},referrer:null===(_d=res2.request)||void 0===_d?void 0:_d.responseURL,method:"GET",mode:"cors"}),data3=yield res3.text();var match=/eval\(function\((.*?)\)\{.*?return p\}.*?\('(.*?)'\.split/.exec(data3);let p="";if(match){var encodedString=match[2];const base=Number(encodedString.split(",'|MDCore|")[0].split(",")[encodedString.split(",'|MDCore|")[0].split(",").length-1]);p=null===(_e=encodedString.split(`',${base},`))||void 0===_e?void 0:_e[0].trim();let a=base,c=encodedString.split(`',${base},`)[1].slice(2).split("|").length,k=encodedString.split(`',${base},`)[1].slice(2).split("|");const decode=function(p,a,c,k,e,d){if(e=function(c){return c.toString(36)},!"".replace(/^/,String)){for(;c--;)d[c.toString(a)]=k[c]||c.toString(a);k=[function(e){return d[e]}],e=function(){return"\\w+"},c=1}for(;c--;)k[c]&&(p=p.replace(new RegExp("\\b"+e(c)+"\\b","g"),k[c]));return p},wurl=null===(_f=decode(p,a,c,k,0,{}).match(/MDCore\.wurl="([^"]+)"/))||void 0===_f?void 0:_f[1];if(wurl){const streamUrl="https:"+wurl;streamLinks.push({server:"Mixdrop "+url.size,link:streamUrl,type:"mp4",headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:101.0) Gecko/20100101 Firefox/101.0",Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8","Accept-Language":"en-US,en;q=0.5","Upgrade-Insecure-Requests":"1","Sec-Fetch-Dest":"iframe","Sec-Fetch-Mode":"navigate","Sec-Fetch-Site":"same-origin",Pragma:"no-cache","Cache-Control":"no-cache",referer:null===(_g=res2.request)||void 0===_g?void 0:_g.responseURL}})}}}catch(fetchErr){}return streamLinks}catch(err){return[]}})};exports.getStream=getStream;